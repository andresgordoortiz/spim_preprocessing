// ============================================================================
// Nextflow Configuration for SPIM Pipeline
// ============================================================================
//
// SEPARATION OF CONCERNS:
// - This file (nextflow.config): Resource allocation, executor settings, SLURM config
// - JSON config (config_medaka_clean.json): Scientific parameters (PSF, Cellpose settings, etc.)
//
// This config defines execution profiles and process-specific resources
// matching the actual processes in spim_pipeline.nf:
//   - EXTRACT_METADATA
//   - PREPROCESS_DECONVOLVE
//   - CELLPOSE_SEGMENT
//   - MERGE_TO_HYPERSTACK
//   - GENERATE_QC_REPORT

manifest {
    name            = 'SPIM 4D Image Processing Pipeline'
    author          = 'Andres Gordo / Guilherme Ventura'
    homePage        = 'https://github.com/yourusername/spim-pipeline'
    description     = 'Pipeline for preprocessing, segmentation, and tracking of 4D SPIM images'
    mainScript      = 'spim_pipeline.nf'
    nextflowVersion = '>=23.04.0'
    version         = '1.0.0'
}

// ============================================================================
// Global Parameters
// ============================================================================

params {
    // Maximum resource limits
    max_memory = 256.GB
    max_cpus = 32
    max_time = 48.h
    max_retries = 1
    container = 'docker://ghcr.io/andresgordoortiz/spim_preprocessing:sha-adbe495'
}

// ============================================================================
// Executor Configuration
// ============================================================================

executor {
    name = 'slurm'
    queueSize = 50
    submitRateLimit = '10 sec'
    pollInterval = '30 sec'
    queueStatInterval = '5 min'
    exitReadTimeout = '30 min'
}

// ============================================================================
// Process Configuration
// ============================================================================

process {
    // Default resources for all processes
    executor = 'slurm'
    errorStrategy = 'terminate'
    maxRetries = params.max_retries

    // Container settings
    container = params.container ?: 'docker://ghcr.io/andresgordoortiz/spim_preprocessing:sha-adbe495'

    // Default resources
    cpus = 4
    memory = 32.GB
    time = 2.h

    // ========================================================================
    // Process-specific resource allocation
    // ========================================================================

    withName: 'EXTRACT_METADATA' {
        cpus = 2
        memory = 8.GB
        time = 30.m
        queue = 'c'
        clusterOptions = '--qos=c_short'

        publishDir = [
            path: { "${params.output_dir}/metadata" },
            mode: 'copy',
            pattern: '*.json'
        ]
    }

    withName: 'PREPROCESS_DECONVOLVE' {
        cpus = 8
        memory = 64.GB
        time = 2.h
        queue = 'g'
        clusterOptions = '--gres=gpu:1'

        publishDir = [
            [
                path: { "${params.output_dir}/01_preprocessed" },
                mode: 'copy',
                pattern: '*_processed.tif'
            ],
            [
                path: { "${params.output_dir}/logs/preprocessing" },
                mode: 'copy',
                pattern: '*.log'
            ]
        ]
    }

    withName: 'CELLPOSE_SEGMENT' {
        cpus = 4
        memory = 64.GB
        time = 2.h
        queue = 'g'
        clusterOptions = '--gres=gpu:1 --exclude=clip-g1-[0-6]'

        publishDir = [
            [
                path: { "${params.output_dir}/02_segmented" },
                mode: 'copy',
                pattern: '*_segmented.tif'
            ],
            [
                path: { "${params.output_dir}/logs/segmentation" },
                mode: 'copy',
                pattern: '*.log'
            ]
        ]
    }

    withName: 'MERGE_TO_HYPERSTACK' {
        cpus = 8
        memory = 128.GB
        time = 1.h
        queue = 'c'
        clusterOptions = '--qos=c_medium'

        publishDir = [
            path: { "${params.output_dir}/03_hyperstack" },
            mode: 'copy'
        ]
    }

    withName: 'GENERATE_QC_REPORT' {
        cpus = 2
        memory = 16.GB
        time = 30.m
        queue = 'c'
        clusterOptions = '--qos=c_short'

        publishDir = [
            path: { "${params.output_dir}/reports" },
            mode: 'copy'
        ]
    }
}

// ============================================================================
// Singularity Configuration
// ============================================================================

singularity {
    enabled = true
    autoMounts = true
    cacheDir = "$params.output_dir/work/.singularity/cache"
    runOptions = '--containall --cleanenv'
}

// ============================================================================
// Report Configuration
// ============================================================================

report {
    enabled = true
    overwrite = true
}

timeline {
    enabled = true
    overwrite = true
}

trace {
    enabled = true
    overwrite = true
    fields = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes'
}

dag {
    enabled = true
    overwrite = true
}

// ============================================================================
// Execution Profiles
// ============================================================================

profiles {
    // Standard profile for production runs
    standard {
        process {
            executor = 'slurm'
            queue = 'g'
        }
    }

    // High-resolution profile with increased resources
    highres {
        process {
            withName: 'PREPROCESS_DECONVOLVE' {
                cpus = 16
                memory = 128.GB
                time = 4.h
            }

            withName: 'CELLPOSE_SEGMENT' {
                cpus = 8
                memory = 128.GB
                time = 4.h
            }

            withName: 'MERGE_TO_HYPERSTACK' {
                memory = 256.GB
                time = 2.h
            }
        }
    }

    // Local profile for testing/development
    local {
        process {
            executor = 'local'
            cpus = 4
            memory = 16.GB
            time = 1.h
        }
    }

    // Testing profile with minimal resources
    test {
        process {
            executor = 'local'
            cpus = 2
            memory = 8.GB
            time = 30.m

            withName: 'PREPROCESS_DECONVOLVE' {
                cpus = 4
                memory = 16.GB
            }

            withName: 'CELLPOSE_SEGMENT' {
                cpus = 2
                memory = 16.GB
            }
        }
    }
}

// ============================================================================
// Cleanup Configuration
// ============================================================================

cleanup = true  // Remove work directory after successful completion

// ============================================================================
// Logging Configuration
// ============================================================================

workDir = "$params.output_dir/work"

env {
    PYTHONUNBUFFERED = '1'
    JAVA_TOOL_OPTIONS = '-Xmx4g'
}