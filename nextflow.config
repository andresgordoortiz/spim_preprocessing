/*
 * Nextflow Configuration for SPIM Pipeline on SLURM
 */

// ============================================================================
// MANIFEST
// ============================================================================

manifest {
    name            = 'SPIM 4D Processing Pipeline'
    author          = 'Adapted from original SLURM scripts'
    homePage        = 'https://github.com/your-repo'
    description     = 'End-to-end pipeline for SPIM image preprocessing, deconvolution, segmentation, and tracking'
    mainScript      = 'spim_pipeline.nf'
    nextflowVersion = '>=23.04.0'
    version         = '1.0.0'
}

// ============================================================================
// EXECUTION PROFILES
// ============================================================================

profiles {

    // Standard SLURM profile
    standard {
        process.executor = 'slurm'
        process.queue = 'g'

        singularity.enabled = true
        singularity.autoMounts = true
        singularity.runOptions = '--nv --cleanenv'

        process {

            // Default resources
            cpus = 4
            memory = 32.GB
            time = 2.h

            // Process-specific resources
            withName: 'EXTRACT_METADATA' {
                cpus = 1
                memory = 8.GB
                time = 10.m
            }

            withName: 'SPLIT_TIMEPOINTS' {
                cpus = 2
                memory = 16.GB
                time = 30.m
            }

            withName: 'PREPROCESS_DECONVOLVE' {
                cpus = 8
                memory = 64.GB
                time = 2.h
                clusterOptions = '--gres=gpu:1'
                containerOptions = '--nv'
            }

            withName: 'CELLPOSE_SEGMENT' {
                cpus = 4
                memory = 64.GB
                time = 2.h
                clusterOptions = '--gres=gpu:1 --exclude=clip-g1-[0-6]'
                containerOptions = '--nv --cleanenv --contain'
            }

            withName: 'MERGE_TIMEPOINTS' {
                cpus = 2
                memory = 32.GB
                time = 1.h
            }

            withName: 'TRACKMATE_TRACK' {
                cpus = 4
                memory = 32.GB
                time = 4.h
            }

            withName: 'GENERATE_QC_REPORT' {
                cpus = 1
                memory = 4.GB
                time = 15.m
            }
        }
    }

    // Local testing profile (no SLURM)
    local {
        process.executor = 'local'

        docker.enabled = true
        docker.runOptions = '--gpus all'

        process {
            cpus = 4
            memory = 16.GB

            withName: 'PREPROCESS_DECONVOLVE' {
                cpus = 8
                memory = 32.GB
            }

            withName: 'CELLPOSE_SEGMENT' {
                cpus = 4
                memory = 32.GB
            }
        }
    }

    // High-performance profile for larger images
    highres {
        process.executor = 'slurm'
        process.queue = 'g'

        singularity.enabled = true
        singularity.autoMounts = true
        singularity.runOptions = '--nv --cleanenv'

        process {

            withName: 'PREPROCESS_DECONVOLVE' {
                cpus = 16
                memory = 128.GB
                time = 6.h
                clusterOptions = '--gres=gpu:1'
            }

            withName: 'CELLPOSE_SEGMENT' {
                cpus = 8
                memory = 128.GB
                time = 4.h
                clusterOptions = '--gres=gpu:1 --exclude=clip-g1-[0-6]'
            }

            withName: 'TRACKMATE_TRACK' {
                cpus = 8
                memory = 64.GB
                time = 8.h
            }
        }
    }
}

// ============================================================================
// GENERAL CONFIGURATION
// ============================================================================

// Execution reports
timeline {
    enabled = true
    file = "${params.output_dir}/reports/timeline.html"
    overwrite = true
}

report {
    enabled = true
    file = "${params.output_dir}/reports/execution_report.html"
    overwrite = true
}

trace {
    enabled = true
    file = "${params.output_dir}/reports/trace.txt"
    overwrite = true
    fields = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes'
}

dag {
    enabled = true
    file = "${params.output_dir}/reports/pipeline_dag.html"
    overwrite = true
}

// Work directory
workDir = "${params.output_dir}/.work"

// Cleanup
cleanup = false  // Set to true to remove work directory after completion

// Resume configuration
resume = true

// Error strategy
process {
    errorStrategy = { task.attempt <= 3 ? 'retry' : 'finish' }
    maxRetries = 3
    maxErrors = '-1'
}

// Container cache
singularity {
    cacheDir = "$HOME/.singularity/cache"
    pullTimeout = '30 min'
}

docker {
    temp = 'auto'
}

// ============================================================================
// RESOURCE LIMITS
// ============================================================================

executor {
    queueSize = 50
    pollInterval = '30 sec'

    $slurm {
        queueSize = 100
        pollInterval = '1 min'
        submitRateLimit = '10 sec'
    }
}
