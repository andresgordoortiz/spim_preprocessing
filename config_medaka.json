{
  "pipeline_info": {
    "version": "1.0.0",
    "description": "SPIM Pipeline Configuration for Medaka Imaging",
    "author": "Andres Gordo / Guilherme Ventura",
    "date_created": "2026-01-27",
    "experiment": "Medaka - low resolution"
  },

  "preprocessing": {
    "description": "Preprocessing and deconvolution parameters optimized for medaka heart",

    "psf_path": "/groups/pinheiro/user/guilherme.ventura/for_analysis/SPIM/things_from_Andres/scripts_from_Andres/image_processing_script/psf_models/PSF_small_low-res.tif",

    "image_scaling": 0.5,
    "comment_scaling": "50% downsampling for faster processing while maintaining quality",

    "xy_pixel": 0.0,
    "z_pixel": 0.0,
    "comment_pixel_size": "0.0 = auto-detect from metadata (recommended)",

    "deconvolution": {
      "niter": 6,
      "niterz": 6,
      "padding": 32,
      "comment": "6 iterations balanced for speed vs quality. Increase for better results."
    },

    "normalization": {
      "min_v": 0,
      "max_v": 65535,
      "percentile_low": 40.0,
      "percentile_high": 99.99,
      "comment": "Remove bottom 40% (background) and top 0.01% (outliers)"
    },

    "background_subtraction": {
      "resolution_px0": 10,
      "resolution_pz0": 10,
      "noise_lvl": 2,
      "comment": "10 micron resolution for background estimation"
    },

    "postprocessing": {
      "sigma": 1.0,
      "comment": "Light Gaussian smoothing to reduce noise"
    },

    "correction_flags": {
      "no_clahe": false,
      "no_z_correction": false,
      "no_shading": false,
      "comment": "All corrections enabled for optimal image quality"
    }
  },

  "segmentation": {
    "description": "Cellpose segmentation optimized for medaka cardiomyocytes",

    "model": "/groups/pinheiro/user/guilherme.ventura/for_analysis/SPIM/things_from_Thomas/cellpose/models/cpsam_Gui_tracking_20250801",
    "comment_model": "Custom Cellpose model trained on medaka heart cells",

    "diameter": 30,
    "comment_diameter": "30 pixels ≈ expected cardiomyocyte size. CRITICAL: Do not use 0 for 3D!",

    "flow_threshold": 0.8,
    "comment_flow": "0.8 = balanced sensitivity. Increase to 1.0-1.5 to reduce over-segmentation",

    "cellprob_threshold": 0.0,
    "comment_cellprob": "0.0 = neutral. Increase to reduce false positives, decrease to catch faint cells",

    "use_gpu": true,
    "do_3d": true,
    "comment_3d": "3D segmentation required for volumetric data",

    "save_tif": true,
    "save_flows": false,
    "save_npy": false,
    "comment_outputs": "Only save TIF masks (required for 3D). Flows and NPY increase storage dramatically.",

    "image_scaling": 0.5,
    "comment_image_scaling": "Must match preprocessing scaling for correct voxel sizes"
  },

  "tracking": {
    "description": "TrackMate parameters for cardiomyocyte tracking across development",

    "detector": {
      "simplify_contours": true,
      "comment": "Simplify cell boundaries for faster tracking without loss of accuracy"
    },

    "linking": {
      "linking_max_distance": 15.0,
      "comment_linking": "15 pixels ≈ maximum expected cell movement between frames. Adjust based on temporal resolution."
    },

    "gap_closing": {
      "allow_gap_closing": true,
      "gap_closing_max_distance": 15.0,
      "max_frame_gap": 2,
      "comment": "Allow missing up to 2 frames. Useful when cells temporarily leave imaging plane."
    },

    "splitting_merging": {
      "allow_track_splitting": false,
      "allow_track_merging": false,
      "comment": "Disable for mature cardiomyocytes (no division). Enable if tracking proliferating cells."
    }
  },

  "system": {
    "description": "System configuration for SLURM cluster",

    "container_image": "docker://ghcr.io/andresgordoortiz/spim_preprocessing:sha-8720eea",
    "comment_container": "Pre-built container with all dependencies",

    "executor": {
      "name": "slurm",
      "queue": "g",
      "comment": "GPU partition on SLURM cluster"
    },

    "resources": {
      "preprocessing": {
        "cpus": 8,
        "memory": "64 GB",
        "gpu": 1,
        "time": "2h",
        "comment": "Standard resources for ~500x500x100 images"
      },
      "segmentation": {
        "cpus": 4,
        "memory": "64 GB",
        "gpu": 1,
        "time": "2h",
        "exclude_nodes": "clip-g1-[0-6]",
        "comment": "Exclude older P100 GPUs, use V100/RTX/A100"
      },
      "tracking": {
        "cpus": 4,
        "memory": "32 GB",
        "gpu": 0,
        "time": "4h",
        "comment": "TrackMate is CPU-only, may need more time for long timeseries"
      }
    }
  }
}